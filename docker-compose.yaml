# ============================================
# Booking Rooms - Docker Compose Configuration
# ============================================
# Production-ready setup with PostgreSQL, FastAPI Backend, React Frontend, and Nginx
#
# Usage:
#   Development: docker-compose up -d
#   Production:  docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up -d
#   Logs:        docker-compose logs -f [service_name]
#   Stop:        docker-compose down
#   Clean:       docker-compose down -v (removes volumes too)

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  db:
    image: postgres:15-alpine
    container_name: booking_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-booking}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-booking_secret_change_me}
      POSTGRES_DB: ${POSTGRES_DB:-booking_rooms}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-booking} -d ${POSTGRES_DB:-booking_rooms}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - booking_network
    restart: unless-stopped

  # ============================================
  # FastAPI Backend
  # ============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: booking_backend
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-booking}:${POSTGRES_PASSWORD:-booking_secret_change_me}@db:5432/${POSTGRES_DB:-booking_rooms}

      # Application
      DEBUG: ${DEBUG:-false}
      SECRET_KEY: ${SECRET_KEY:-change-this-in-production-use-openssl-rand-hex-32}
      APP_NAME: ${APP_NAME:-Sistema de Reservas IES}

      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost,http://localhost:3000,http://localhost:80}

      # Google OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - booking_network
    restart: unless-stopped
    # Uncomment for development hot-reload:
    # volumes:
    #   - ./app:/app/app
    #   - ./main.py:/app/main.py

    # ============================================
    # React Frontend (served by Nginx internally)
    # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /api
    container_name: booking_frontend
    depends_on:
      - backend
    networks:
      - booking_network
    restart: unless-stopped

  # ============================================
  # Nginx Reverse Proxy (main entry point)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: booking_nginx
    ports:
      - "${HTTP_PORT:-80}:80"
      # Uncomment for HTTPS:
      # - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Uncomment for HTTPS:
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
    networks:
      - booking_network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ============================================
  # Adminer - Database Management UI
  # ============================================
  adminer:
    image: adminer:latest
    container_name: booking_adminer
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
      ADMINER_DESIGN: nette
    depends_on:
      - db
    networks:
      - booking_network
    restart: unless-stopped

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    name: booking_postgres_data

# ============================================
# Networks
# ============================================
networks:
  booking_network:
    driver: bridge
    name: booking_network
